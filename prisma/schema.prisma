generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                      String             @id @default(cuid())
  name                    String
  licenseTier             LicenseTier        @default(STARTER)
  subscriptionStatus      SubscriptionStatus @default(TRIAL)
  stripeCustomerId        String?            @unique
  settings                String             @default("{}")
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  notificationSettings    String?            @default("{}")
  slug                    String             @unique
  dailyPrice              Int?
  dailyStudentPrice       Int?
  monthlyPassPrice        Int?
  monthlyPassStudentPrice Int?
  privateSessionPrice     Int?
  bankAccountName         String?
  bankAccountNumber       String?
  bankName                String?
  setupToken              String?            @unique
  trialEndsAt             DateTime?
  setupCompletedAt        DateTime?
  stripeSubscriptionId    String?            @unique
  currency                String?            @default("EUR")
  groups                  Group[]
  joinRequests            JoinRequest[]
  locations               Location[]
  roles                   Role[]
  sessions                Session[]
  students                Student[]
  users                   User[]

  @@map("organizations")
}

model Location {
  id             String        @id @default(cuid())
  name           String
  address        String?
  city           String?
  phone          String?
  email          String?
  capacity       Int?
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions       Session[]

  @@map("locations")
}

model JoinRequest {
  id             String            @id @default(cuid())
  email          String
  name           String
  phone          String?
  message        String?
  organizationId String?
  status         JoinRequestStatus @default(PENDING)
  processedBy    String?
  processedAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@map("join_requests")
}

model Group {
  id             String         @id @default(cuid())
  name           String
  description    String?
  organizationId String?
  dailyFee       Float          @default(0)
  monthlyFee     Float          @default(0)
  currency       String         @default("HUF")
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  students       StudentGroup[]

  @@map("groups")
}

model StudentGroup {
  id        String   @id @default(cuid())
  studentId String
  groupId   String
  joinedAt  DateTime @default(now())
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId])
  @@map("student_groups")
}

model Role {
  id             String        @id @default(cuid())
  name           String
  organizationId String?
  permissions    String        @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User[]

  @@unique([name, organizationId])
  @@map("roles")
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String?
  image                   String?
  password                String?
  role                    UserRole           @default(STUDENT)
  organizationId          String?
  roleId                  String?
  emailVerified           DateTime?
  notificationPreferences String?            @default("{}")
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  phone                   String?
  accounts                Account[]
  attendances             Attendance[]
  authSessions            AuthSession[]      @relation("UserSessions")
  notifications           Notification[]
  pushSubscriptions       PushSubscription[]
  sessions                Session[]          @relation("TrainerSessions")
  student                 Student?
  organization            Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customRole              Role?              @relation(fields: [roleId], references: [id])

  @@map("users")
}

model Student {
  id                      String         @id @default(cuid())
  firstName               String
  lastName                String
  email                   String?
  phone                   String?
  dateOfBirth             DateTime?
  address                 String?
  emergencyContact        String?
  medicalInfo             String?
  beltLevel               String?
  status                  StudentStatus  @default(ACTIVE)
  photo                   String?
  documents               String?        @default("[]")
  organizationId          String?
  notificationPreferences String?        @default("{}")
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  userId                  String?        @unique
  attendances             Attendance[]
  paymentPlans            PaymentPlan[]
  payments                Payment[]
  groups                  StudentGroup[]
  organization            Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                    User?          @relation(fields: [userId], references: [id])

  @@map("students")
}

model Session {
  id             String        @id @default(cuid())
  title          String
  description    String?
  trainerId      String
  organizationId String?
  startTime      DateTime
  endTime        DateTime
  capacity       Int           @default(10)
  location       String?
  sessionType    SessionType   @default(REGULAR)
  calendarColor   String?
  isRecurring    Boolean       @default(false)
  recurringRule  String?
  status         SessionStatus @default(SCHEDULED)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  locationId     String?
  attendances    Attendance[]
  locationRef    Location?     @relation(fields: [locationId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainer        User          @relation("TrainerSessions", fields: [trainerId], references: [id])

  @@map("sessions")
}

model Attendance {
  id          String           @id @default(cuid())
  sessionId   String
  studentId   String
  userId      String
  status      AttendanceStatus @default(PRESENT)
  checkInTime DateTime?
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  session     Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  markedBy    User             @relation(fields: [userId], references: [id])

  @@unique([sessionId, studentId])
  @@map("attendance")
}

model PaymentPlan {
  id          String           @id @default(cuid())
  studentId   String
  name        String
  amount      Float
  frequency   PaymentFrequency
  startDate   DateTime
  endDate     DateTime?
  description String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@map("payment_plans")
}

model Payment {
  id                    String        @id @default(cuid())
  studentId             String
  paymentPlanId         String?
  amount                Float
  paymentType           PaymentType   @default(TUITION)
  status                PaymentStatus @default(PENDING)
  dueDate               DateTime
  paidDate              DateTime?
  paymentMethod         PaymentMethod @default(CASH)
  stripePaymentIntentId String?
  notes                 String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  paymentPlan           PaymentPlan?  @relation(fields: [paymentPlanId], references: [id])
  student               Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model AuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  read      Boolean          @default(false)
  actionUrl String?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@map("push_subscriptions")
}

enum LicenseTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  PRO
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TRAINER
  STUDENT
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  GRADUATED
}

enum SessionType {
  REGULAR
  PRIVATE
  GROUP
  SEMINAR
  GRADING
}

enum SessionStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum PaymentFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PaymentType {
  TUITION
  PRIVATE_LESSON
  SEMINAR
  EQUIPMENT
  MEMBERSHIP
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHECK
  STRIPE
  PAYPAL
  OTHER
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}
